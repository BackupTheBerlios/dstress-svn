<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN" "http://www.w3.org/TR/html4/loose.dtd">
<html><head>
  <meta content="text/html; charset=utf-8" http-equiv="Content-Type">
  <title>data</title>
  <link href="../../www/formate.css" type="text/css" rel="stylesheet">
  <style type="text/css">
.good { background-color:#00FF00; }
.bad { background-color:#FF0000; }
td { text-align:right;}
  </style></head><body dir="ltr" style="background-color: rgb(255, 255, 255);">

<center><h2>Summing large arrays (performance of tight loops)</h2>
<small>Thomas KÃ¼hne &lt;<a href="mailto:thomas@kuehne.cn">thomas@kuehne.cn</a>&gt;</small>
</center>

<blockquote>
What is the best way to sum 2<sup>20</sup> to 2<sup>28</sup> array elements in D? Below you'll find <a href="#source">9 different functions</a>
for summing arrays. While all of these have the same time complexity
and should result in exactly the same results for integer arrays the
performance vary quite drastically.
<br>
(skip to the <a href="#results">results</a>)
</blockquote>

<h3><a name="setup"></a>Setup</h3>
<blockquote>
The arrays were allocated via <i>calloc(array_length, element_size)</i> and the elements filled with their array index (e.g. array element 5 had the value 5). The standard D way <i>new type[array_length]</i> couldn't be used because both DMD's Phobos as well as GDC's GPhobos failed to handle unsuccessful allocations of large (2<sup>+26</sup>)
arrays. Every function was executed ten times and the total time in
microseconds used as the performance score. Testing was done on a AMD Turion with 2GB ram.</blockquote>

<h3><a name="data"></a>Data</h3>

<blockquote>
<p>Smaller numbers are better.</p>
<table border="1"><tbody><tr><th><i>sum(int[]) - DMD-1.011</i></th><th><a href="#foreach">foreach</a></th><th><a href="#array">array</a></th><th><a href="#const_length">const length</a></th><th><a href="#pointer">pointer</a></th><th><a href="#pointer_2a">pointer 2a</a></th><th><a href="#pointer_2b">pointer 2b</a></th><th><a href="#pointer_2c">pointer 2c</a></th><th><a href="#struct2">struct2</a></th><th><a href="#struct4">struct4</a></th></tr><tr><th>2^20</th><td class="bad">39487</td><td>29846</td><td>24341</td><td>25195</td><td class="good">18537</td><td>19057</td><td>19961</td><td>19020</td><td>24969</td></tr><tr><th>2^21</th><td class="bad">73997</td><td>57552</td><td>46594</td><td>50114</td><td class="good">36400</td><td>36508</td><td>39229</td><td>37772</td><td>51565</td></tr><tr><th>2^22</th><td class="bad">150230</td><td>122630</td><td>93768</td><td>98350</td><td class="good">73073</td><td>73384</td><td>77028</td><td>74370</td><td>99221</td></tr><tr><th>2^23</th><td class="bad">292691</td><td>236082</td><td>183791</td><td>196665</td><td>143398</td><td class="good">142987</td><td>161674</td><td>148839</td><td>195495</td></tr><tr><th>2^24</th><td>1175839</td><td>913347</td><td>912137</td><td>778297</td><td class="good">603129</td><td>761136</td><td>608608</td><td>623014</td><td class="bad">1258316</td></tr><tr><th>2^25</th><td class="bad">2373532</td><td>2181018</td><td>1527581</td><td>1768198</td><td class="good">1143496</td><td>1150346</td><td>1243648</td><td>1225862</td><td>1570916</td></tr><tr><th>2^26</th><td class="bad">4851729</td><td>3648426</td><td>3196856</td><td>3139241</td><td class="good">2284931</td><td>2375935</td><td>2626162</td><td>3072473</td><td>4573186</td></tr><tr><th>2^27</th><td class="bad">11308678</td><td>7284736</td><td>6151410</td><td>6253621</td><td class="good">4562178</td><td>4590524</td><td>4892955</td><td>4704366</td><td>6495310</td></tr><tr><th>2^28</th><td class="bad">19939066</td><td>14503930</td><td>11779464</td><td>12453572</td><td>9423131</td><td class="good">9184663</td><td>9793640</td><td>9858083</td><td>13109742</td></tr></tbody></table>
<br><table border="1"><tbody><tr><th><i>sum(int[]) - GDC-0.23</i></th><th><a href="#foreach">foreach</a></th><th><a href="#array">array</a></th><th><a href="#const_length">const length</a></th><th><a href="#pointer">pointer</a></th><th><a href="#pointer_2a">pointer 2a</a></th><th><a href="#pointer_2b">pointer 2b</a></th><th><a href="#pointer_2c">pointer 2c</a></th><th><a href="#struct2">struct2</a></th><th><a href="#struct4">struct4</a></th></tr><tr><th>2^20</th><td>33905</td><td>33765</td><td>36656</td><td>36614</td><td>33935</td><td class="bad">36776</td><td class="good">33667</td><td>34220</td><td>36708</td></tr><tr><th>2^21</th><td>68606</td><td>66152</td><td>72531</td><td>72836</td><td>66480</td><td>72567</td><td class="good">66191</td><td>66820</td><td class="bad">83352</td></tr><tr><th>2^22</th><td>131675</td><td class="good">128806</td><td class="bad">145258</td><td>145159</td><td>130948</td><td>143583</td><td>141416</td><td>131424</td><td>145110</td></tr><tr><th>2^23</th><td>260759</td><td class="good">257600</td><td>294391</td><td>287307</td><td>260200</td><td>295746</td><td class="bad">329018</td><td>263779</td><td>293465</td></tr><tr><th>2^24</th><td class="good">520159</td><td>521603</td><td>568738</td><td>629862</td><td class="bad">737227</td><td>568174</td><td>530669</td><td>522560</td><td>576958</td></tr><tr><th>2^25</th><td>1054166</td><td class="good">1029775</td><td class="bad">1145534</td><td>1145042</td><td>1043372</td><td>1143455</td><td>1049781</td><td>1052983</td><td>1142737</td></tr><tr><th>2^26</th><td>2087338</td><td class="good">2065728</td><td class="bad">2288074</td><td>2285380</td><td>2083681</td><td>2286603</td><td>2106958</td><td>2100707</td><td>2284949</td></tr><tr><th>2^27</th><td>4170883</td><td class="good">4113056</td><td>4583107</td><td>4581479</td><td>4170349</td><td>4574770</td><td>4198121</td><td>4241094</td><td class="bad">4865397</td></tr><tr><th>2^28</th><td>8487888</td><td class="good">8267262</td><td class="bad">9190723</td><td>9185441</td><td>8480895</td><td>9469061</td><td>8726432</td><td>8418852</td><td>9187261</td></tr></tbody></table>
<br><table border="1"><tbody><tr><th><i>sum(float[]) - DMD-1.011</i></th><th><a href="#foreach">foreach</a></th><th><a href="#array">array</a></th><th><a href="#const_length">const length</a></th><th><a href="#pointer">pointer</a></th><th><a href="#pointer_2a">pointer 2a</a></th><th><a href="#pointer_2b">pointer 2b</a></th><th><a href="#pointer_2c">pointer 2c</a></th><th><a href="#struct2">struct2</a></th><th><a href="#struct4">struct4</a></th></tr><tr><th>2^20</th><td>104,584</td><td class="good">56,464</td><td>179,892</td><td>228,684</td><td>101,692</td><td>194,298</td><td>230,061</td><td>187,213</td><td class="bad">296,968</td></tr><tr><th>2^21</th><td>234,158</td><td class="good">117,309</td><td>358,791</td><td>360,352</td><td>204,909</td><td>445,710</td><td class="bad">566,972</td><td>186,661</td><td>349,429</td></tr><tr><th>2^22</th><td>408,780</td><td class="good">221,424</td><td>721,992</td><td>711,698</td><td>401,641</td><td>721,752</td><td class="bad">777,944</td><td>593,617</td><td>726,188</td></tr><tr><th>2^23</th><td>826,775</td><td class="good">443,228</td><td>1,442,361</td><td>1,411,166</td><td>812,180</td><td>1,442,146</td><td class="bad">1,451,274</td><td>744,959</td><td>1,402,958</td></tr><tr><th>2^24</th><td>1,645,775</td><td class="good">879,525</td><td>2,873,823</td><td>2,829,072</td><td>1,620,790</td><td>2,873,192</td><td class="bad">2,908,794</td><td>1,479,099</td><td>2,811,043</td></tr><tr><th>2^25</th><td>3,286,693</td><td class="good">1,767,557</td><td>5,743,333</td><td>5,652,024</td><td>3,236,135</td><td>5,742,945</td><td class="bad">5,819,018</td><td>2,959,554</td><td>5,622,600</td></tr><tr><th>2^26</th><td>6,567,994</td><td class="good">3,541,314</td><td>11,483,121</td><td>11,293,087</td><td>6,467,498</td><td>11,483,688</td><td class="bad">11,597,877</td><td>6,050,549</td><td>11,237,598</td></tr><tr><th>2^27</th><td>13,126,155</td><td class="good">7,077,687</td><td>22,953,176</td><td>23,165,154</td><td>13,016,702</td><td class="bad">24,006,338</td><td>23,210,629</td><td>12,049,252</td><td>23,470,996</td></tr><tr><th>2^28</th><td>26,661,849</td><td class="good">14,460,236</td><td>47,305,046</td><td class="bad">48,538,986</td><td>27,584,410</td><td>45,884,787</td><td>46,703,483</td><td>23,691,245</td><td>45,533,893</td></tr></tbody></table>
<br><table border="1"><tbody><tr><th><i>sum(float[]) - GDC-0.23</i></th><th><a href="#foreach">foreach</a></th><th><a href="#array">array</a></th><th><a href="#const_length">const length</a></th><th><a href="#pointer">pointer</a></th><th><a href="#pointer_2a">pointer 2a</a></th><th><a href="#pointer_2b">pointer 2b</a></th><th><a href="#pointer_2c">pointer 2c</a></th><th><a href="#struct2">struct2</a></th><th><a href="#struct4">struct4</a></th></tr><tr><th>2^20</th><td>40,100</td><td class="good">36,123</td><td>61,085</td><td class="bad">61,952</td><td>37,749</td><td>60,448</td><td>60,823</td><td>60,080</td><td>60,178</td></tr><tr><th>2^21</th><td>76,927</td><td class="good">70,679</td><td>120,330</td><td class="bad">128,126</td><td>74,606</td><td>118,584</td><td>117,482</td><td>119,905</td><td>121,072</td></tr><tr><th>2^22</th><td>149,637</td><td>150,945</td><td>235,033</td><td>236,031</td><td class="good">145,774</td><td>234,485</td><td>243,789</td><td>236,741</td><td class="bad">282,689</td></tr><tr><th>2^23</th><td>302,977</td><td>376,907</td><td class="bad">754,182</td><td>477,703</td><td class="good">286,107</td><td>469,333</td><td>474,149</td><td>511,084</td><td>657,263</td></tr><tr><th>2^24</th><td>600,411</td><td class="good">550,026</td><td>943,535</td><td class="bad">946,752</td><td>578,923</td><td>933,801</td><td>940,072</td><td>935,879</td><td>944,541</td></tr><tr><th>2^25</th><td>1,192,165</td><td class="good">1,105,892</td><td class="bad">1,889,572</td><td>1,883,737</td><td>1,146,901</td><td>1,887,318</td><td>1,869,101</td><td>2,242,656</td><td>1,886,341</td></tr><tr><th>2^26</th><td>2,384,673</td><td class="good">2,209,293</td><td>3,768,365</td><td>3,772,416</td><td>2,288,746</td><td>3,768,794</td><td>3,733,957</td><td>3,729,306</td><td class="bad">4,122,289</td></tr><tr><th>2^27</th><td>5,038,215</td><td class="good">4,430,383</td><td>7,522,700</td><td>7,533,278</td><td>4,580,962</td><td>7,528,176</td><td>7,709,803</td><td>7,632,599</td><td class="bad">8,005,256</td></tr><tr><th>2^28</th><td>10,342,558</td><td class="good">8,868,552</td><td>15,560,921</td><td>15,481,551</td><td>9,201,479</td><td>15,044,718</td><td>15,564,101</td><td>15,045,353</td><td class="bad">16,094,330</td></tr></tbody></table>
</blockquote>






<h3><a name="results"></a>Results</h3>





<blockquote><dl>
<dt>integer arrays<br>
</dt>
<dd><ol>
	
	<li>the performance of the 9 different functions differs much more for DMD (factor 2) than for GDC (factor 1.4)</li>
	<li>DMD's <a href="#foreach">foreach</a> is 2 times slower than <a href="#pointer_2a">pointer 2a</a> and <a href="#pointer_2b">pointer 2b</a></li>
	<li>GDC's <a href="#array">array</a> is the clear winner and <a href="#const_length">const length</a> as well as <a href="#struct4">struct4</a> the overall losers</li>
	<li>GDC's best results for less than 2<sup>24</sup> elements are ca. 1.8 times slower than DMD's</li></ol></dd>
<dt>float arrays</dt>
<dd>
      <ol>
	<li>the performance of the 9 different functions differs much more for DMD (factor 3.4) than for GDC (factor 2)</li>
        <li>both DMD's and GDC's <a href="#array">array</a> are the clear performance winners</li>
        <li>DMD's best results are consistently ca. 1.6 times slower than GDC's<br>
        </li>

      </ol>
    </dd>
<dt>overall</dt>
<dd>
<ul><li>considering that <a href="#foreach">foreach</a> is a native D construct and provides all required information the slow code generated by DMD is worrying</li>
        <li>equally worrying is that DMD and GDC (as well as GCC) failed to use SSE instructions for <a href="#struct4">struct4</a><br>
        </li>
</ul>
</dd></dl>
<p>Please keep in mind that the preformed tests strongly depend on the
memory architecture and don't really measure how fast an addition is
but how efficiently the memory reads - and to a lesser extend writes -
are scheduled by the compiler.
</p></blockquote>





<h3><a name="source"></a>Source</h3>






<blockquote><pre><code><br><a name="foreach"></a>T sum_foreach(T)(T[] data){<br>	T result = 0;<br>	foreach(element; data){<br>		result += element;<br>	}<br>	return result;<br>}<br><br><a name="array"></a>T sum_array(T)(T[] data){<br>	T result = 0;<br>	size_t index = 0;<br>	while(index &lt; data.length){<br>		result += data[index];<br>		index++;<br>	}<br>	return result;<br>}<br><br><a name="const_length"></a>T sum_array_const_length(T)(T[] data){<br>	T result = 0;<br>	size_t length = data.length;<br>	size_t index = 0;<br>	while(index &lt; length){<br>		result += data[index];<br>		index++;<br>	}<br>	return result;<br>}<br><br><a name="pointer"></a>T sum_pointer(T)(T[] data){<br>	T result = 0;<br>	auto end = data.ptr + data.length;<br>	auto ptr = data.ptr;<br>	<br>	while(ptr != end){<br>		result += *ptr;<br>		ptr++;<br>	}<br>	return result;<br>}<br><br><a name="pointer_2a"></a>T sum_pointer_2a(T)(T[] data){<br>	T result_a = 0;<br>	T result_b = 0;<br>	<br>	auto end = data.ptr + data.length;<br>	<br>	auto ptr_a = data.ptr;<br>	auto ptr_b = data.ptr + 1;<br><br>	while(ptr_b &lt; end){<br>		result_a += *ptr_a;<br>		result_b += *ptr_b;<br>		ptr_a += 2;<br>		ptr_b += 2;<br>	}<br><br>	if(ptr_a ;&amp;l; end){<br>		result_a += *ptr_a;<br>	}<br>	return result_a + result_b;<br>}<br><br><a name="pointer_2b"></a>T sum_pointer_2b(T)(T[] data){<br>	T result = 0;<br>	<br>	auto end = data.ptr + data.length;<br>	<br>	auto ptr_a = data.ptr;<br>	auto ptr_b = data.ptr + 1;<br><br>	while(ptr_b &lt; end){<br>		result += *ptr_a;<br>		ptr_a += 2;<br>		result += *ptr_b;<br>		ptr_b += 2;<br>	}<br><br>	if(ptr_a &lt; end){<br>		result += *ptr_a;<br>	}<br>	return result;<br>}<br><br><a name="pointer_2c"></a>T sum_pointer_2c(T)(T[] data){<br>	T result = 0;<br><br>	if(0 != data.length){<br>		auto end = data.ptr + data.length - 1;<br>		auto ptr = data.ptr;<br><br>		while(ptr &lt; end){<br>			result += *(ptr+0);<br>			result += *(ptr+1);<br>			ptr += 2;<br>		}<br><br>		if(ptr == end){<br>			result += *ptr;<br>		}<br>	}<br>	return result;<br>}<br><br><a name="struct2"></a>T sum_struct2(T)(T[] data){<br>	struct S{<br>		T a = 0;<br>		T b = 0;<br>	}<br><br>	S result;<br>	S* s = cast(S*) data.ptr;<br>	S* end = s + (data.length / 2);<br>	while(s &lt; end){<br>		result.a += s.a;<br>		result.b += s.b;<br>		s++;<br>	}<br><br>	switch(data.length % 2){<br>		case 1:<br>			result.a += s.a;<br>		case 0:<br>			break;<br>	}<br><br>	return result.a + result.b;<br>}<br><br><a name="struct4"></a>T sum_struct4(T)(T[] data){<br>	struct S{<br>		T a = 0;<br>		T b = 0;<br>		T c = 0;<br>		T d = 0;<br>	}<br><br>	S result;<br>	S* s = cast(S*) data.ptr;<br>	S* end = s + (data.length / 4);<br>	while(s &lt; end){<br>		result.a += s.a;<br>		result.b += s.b;<br>		result.c += s.c;<br>		result.d += s.d;<br>		s++;<br>	}<br>	<br>	switch(data.length % 4){<br>		case 3:<br>			result.c += s.c;<br>		case 2:<br>			result.b += s.b;<br>		case 1:<br>			result.a += s.a;<br>		case 0:<br>			break;<br>	}<br><br>	return result.a + result.b + result.c + result.d;<br>}<br></code></pre></blockquote>







<hr>
<center><a href="http://developer.berlios.de"><img src="http://developer.berlios.de/bslogo.php?group_id=2732" width="124" height="32" border="0" alt="BerliOS Logo" /></a></center>
</body></html>
